<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="referrer" content="no-referrer">
<title>Liquid Glass Pro Final</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
<style>
    :root {
        --accent: #d4af37;
        --blob-1: #4facfe; --blob-2: #f093fb; --blob-3: #43e97b;
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.12);
        --glass-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        --text: #ffffff;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        background: #050505; height: 100vh; width: 100vw;
        display: flex; justify-content: center; align-items: center;
        overflow: hidden; color: var(--text);
        user-select: none; -webkit-user-select: none;
    }

    /* --- BACKGROUND --- */
    .liquid-bg { position: absolute; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: radial-gradient(circle at 50% 50%, #121212, #000); }
    .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 12s infinite alternate; transition: background-color 1.5s ease; }
    .orb-1 { width: 500px; height: 500px; background: var(--blob-1); top: -10%; left: -10%; }
    .orb-2 { width: 400px; height: 400px; background: var(--blob-2); bottom: -10%; right: -5%; animation-delay: -5s; }
    .orb-3 { width: 300px; height: 300px; background: var(--blob-3); top: 40%; left: 30%; opacity: 0.4; animation-delay: -2s; }

    /* --- LAYOUT UTAMA --- */
    .app-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }

    .glass-card {
        background: var(--glass-bg); backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);
        
        /* PC Size */
        width: 380px; height: 720px; max-height: 95vh;
        border-radius: 44px; padding: 40px 32px;
        
        position: relative;
        display: flex; flex-direction: column; justify-content: space-between;
        transition: opacity 0.5s ease;
    }

    .hidden-view { display: none !important; opacity: 0; }

    /* --- SETUP VIEW --- */
    #setupView { justify-content: center; text-align: center; }
    .setup-icon svg { width: 60px; fill: white; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); margin-bottom: 15px; }
    h1 { font-size: 1.8rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
    p.desc { font-size: 0.9rem; opacity: 0.6; margin: 5px 0 25px 0; }
    .glass-input { width: 100%; padding: 16px; border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: white; font-size: 0.95rem; outline: none; text-align: center; }
    .glass-input:focus { background: rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.3); }
    .btn-connect { width: 100%; padding: 18px; border-radius: 18px; border: none; background: white; color: black; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; }

    /* --- PLAYER COMPONENTS --- */
    
    /* 1. ART */
    .art-wrapper {
        width: 100%; display: flex; justify-content: center; align-items: center;
        flex-shrink: 0; /* Jangan mengecil di PC */
        margin-bottom: 15px;
    }
    .album-art {
        width: 280px; height: 280px; border-radius: 24px;
        overflow: hidden; background: #222; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        position: relative;
    }
    .album-art img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .scan-badge {
        position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        padding: 6px 12px; border-radius: 12px; font-size: 0.65rem; font-weight: 700; opacity: 0; transition: 0.3s;
    }

    /* 2. INFO & BADGE */
    .info-container { 
        text-align: center; margin-bottom: 10px; min-height: 80px; 
        display: flex; flex-direction: column; justify-content: center;
    }
    .track-marquee { overflow: hidden; width: 100%; white-space: nowrap; padding: 5px 0; margin-bottom: -5px; mask-image: linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent); }
    .song-title-wrapper { display: inline-block; padding-left: 0; }
    .song-title { font-size: 1.5rem; font-weight: 700; display: inline-block; line-height: 1.4; }
    .artist-name { font-size: 1rem; opacity: 0.6; margin: 4px 0 10px; }

    /* 3. BADGE STYLES */
    .quality-badge {
        display: none; align-items: center; justify-content: center;
        padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1px;
        text-transform: uppercase; margin: 0 auto; width: fit-content; transition: 0.3s;
    }
    .quality-badge.lossless {
        display: inline-flex; border: 1px solid var(--accent); 
        color: var(--accent); background: rgba(255, 255, 255, 0.05); box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    .quality-badge.hires {
        display: inline-flex; border: 1px solid #4facfe; 
        color: #4facfe; background: rgba(79, 172, 254, 0.1); box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
    }

    /* 4. SLIDER */
    .slider-wrapper { width: 100%; margin-bottom: 10px; }
    input[type=range] { width: 100%; background: transparent; -webkit-appearance: none; cursor: pointer; display: block; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .time-row { display: flex; justify-content: space-between; font-size: 0.75rem; opacity: 0.5; margin-top: 8px; font-weight: 600; font-family: monospace; }

    /* 5. CONTROLS */
    .controls-row { display: flex; justify-content: center; align-items: center; width: 100%; gap: 15px; padding-bottom: 5px; }
    .btn-icon { background: none; border: none; color: rgba(255,255,255,0.6); cursor: pointer; padding: 12px; transition: 0.2s; }
    .btn-icon:active { transform: scale(0.85); color: white; }
    .btn-icon svg { width: 26px; height: 26px; fill: currentColor; }
    
    .btn-play {
        width: 75px; height: 75px; flex-shrink: 0; border-radius: 50%;
        background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1); color: white;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.3s; margin: 0 10px;
    }
    .btn-play svg { width: 32px; height: 32px; fill: currentColor; }
    .btn-play:active { transform: scale(0.9); }
    .playing .btn-play { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 30px var(--accent); }

    /* --- MOBILE ADJUSTMENTS (TOMBOL TURUN) --- */
    @media (max-width: 480px) {
        .glass-card { 
            width: 100%; height: 100vh; border-radius: 0; border: none; 
            padding: 30px 25px 40px 25px; /* Padding bawah extra untuk jempol */
            justify-content: flex-end; /* FIX: Dorong semua konten ke bawah */
        }
        
        .art-wrapper {
            margin-top: auto; /* FIX: Dorong Art ke atas mengisi ruang kosong */
            margin-bottom: auto; /* Center vertical di area atas */
            height: auto;
        }
        
        .album-art { 
            width: 80vw; height: 80vw; 
            max-width: 320px; max-height: 320px; 
        }

        .controls-row {
            padding-bottom: 20px; /* Jarak aman dari edge bawah HP */
        }
    }

    @keyframes scrollText { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
    @keyframes floatOrb { 0% { transform: translate(0, 0); } 100% { transform: translate(20px, 40px); } }
</style>
</head>
<body oncontextmenu="return false;"> 

    <div class="liquid-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <canvas id="colorCanvas" style="display:none;"></canvas>

    <div class="app-container">
        <div id="setupView" class="glass-card" style="justify-content: center;">
            <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                <div class="setup-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
                <h1>LosslessPlay</h1>
                <p class="desc">High Fidelity Streamer</p>
                <input type="text" id="apiKeyInput" class="glass-input" placeholder="Google Drive API Key" autocomplete="off">
                <input type="text" id="folderLinkInput" class="glass-input" placeholder="Google Drive Folder Link" autocomplete="off">
                <p id="errorMsg" style="color:#ff6b6b; font-size:0.75rem; margin-top:5px; min-height:15px;"></p>
                <button class="btn-connect" onclick="initFolderSystem()">CONNECT</button>
            </div>
        </div>

        <div id="playerView" class="glass-card hidden-view">
            
            <div class="art-wrapper">
                <div class="album-art">
                    <span id="scanBadge" class="scan-badge">SCANNING...</span>
                    <img id="albumCover" src="./cover.png" crossorigin="anonymous">
                </div>
            </div>

            <div class="info-container">
                <div class="track-marquee">
                    <div class="song-title-wrapper" id="titleWrapper">
                        <span class="song-title" id="trackTitle">Loading...</span>
                    </div>
                </div>
                <p class="artist-name" id="playlistInfo">Playlist 0/0</p>
                <div id="qualityBadge" class="quality-badge">LOSSLESS</div>
            </div>

            <div class="slider-wrapper">
                <input type="range" id="progressBar" value="0" min="0" step="1">
                <div class="time-row">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="controls-row">
                <button class="btn-icon" id="btnShuffle" onclick="toggleShuffle()"><svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg></button>
                <button class="btn-icon" onclick="prevTrack()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-play" id="btnPlay" onclick="togglePlay()">
                    <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button class="btn-icon" onclick="nextTrack()"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <button class="btn-icon" id="btnRepeat" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v6z"/></svg></button>
            </div>
            
            <button onclick="resetPlayer()" style="margin-top:10px; background:none; border:none; color:rgba(255,255,255,0.2); font-size:0.75rem; cursor:pointer; letter-spacing:1px;">SWITCH FOLDER</button>
        </div>
    </div>

    <audio id="audio" crossorigin="anonymous" controlsList="nodownload"></audio>

<script>
    const jsmediatags = window.jsmediatags;
    const audio = document.getElementById('audio');
    const setupView = document.getElementById('setupView');
    const playerView = document.getElementById('playerView');
    const errorMsg = document.getElementById('errorMsg');
    const scanBadge = document.getElementById('scanBadge');
    const qualityBadge = document.getElementById('qualityBadge');
    const btnShuffle = document.getElementById('btnShuffle');
    
    let playlist = [];
    let currentIndex = 0;
    let isPlaying = false;
    let isRepeat = false;
    let isShuffle = false;
    let globalApiKey = ""; 

    document.onkeydown = function(e) { if(e.keyCode == 123) return false; }

    async function initFolderSystem() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        const folderUrl = document.getElementById('folderLinkInput').value.trim();

        if (!apiKey || !folderUrl) { errorMsg.textContent = "Data Incomplete"; return; }
        const folderId = folderUrl.match(/[-\w]{25,}/)?.[0];
        if (!folderId) { errorMsg.textContent = "Invalid Link"; return; }

        globalApiKey = apiKey;
        document.querySelector('.btn-connect').textContent = "Authenticating...";

        try {
            const query = `'${folderId}' in parents and mimeType contains 'audio' and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,thumbnailLink,mimeType,size)&key=${apiKey}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.error) throw new Error(data.error.message);
            if (!data.files || data.files.length === 0) throw new Error("Folder Empty");

            playlist = data.files;
            setupView.classList.add('hidden-view');
            playerView.classList.remove('hidden-view');
            loadTrack(0);

        } catch (err) {
            errorMsg.textContent = err.message;
            document.querySelector('.btn-connect').textContent = "CONNECT";
        }
    }

    function loadTrack(index) {
        if(playlist.length === 0) return;
        const track = playlist[index];

        const titleClean = track.name.replace(/\.[^/.]+$/, "");
        document.getElementById('trackTitle').textContent = titleClean;
        document.getElementById('playlistInfo').textContent = `Track ${index + 1} / ${playlist.length}`;
        
        checkTitleLength();
        
        // Pass complete data for detection
        determineQuality(track.mimeType, track.name);

        document.getElementById('albumCover').src = "./cover.png";
        resetTheme();

        const streamUrl = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${globalApiKey}`;
        audio.src = streamUrl;
        
        audio.play().then(() => { isPlaying = true; updatePlayIcon(); }).catch(e => console.log("Buffering..."));
        extractCoverArt(streamUrl);
    }

    // --- LOGIC BADGE (FIXED: MP3=Hidden, FLAC=Gold) ---
    function determineQuality(mime, filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const mimeType = mime ? mime.toLowerCase() : "";
        const nameLower = filename.toLowerCase();
        
        // Default Hide
        qualityBadge.style.display = 'none';
        qualityBadge.className = 'quality-badge';

        // Check Lossless (FLAC/WAV/AIFF) by Extension OR MimeType
        if (mimeType.includes("flac") || mimeType.includes("wav") || ext === 'flac' || ext === 'wav' || ext === 'aiff') {
            qualityBadge.style.display = 'inline-flex';
            
            // Check Hi-Res (Simulation from filename keyword)
            if (nameLower.includes("96k") || nameLower.includes("24bit") || nameLower.includes("192k") || nameLower.includes("88k") || nameLower.includes("hi-res")) {
                qualityBadge.classList.add('hires');
                qualityBadge.textContent = "HI-RES LOSSLESS";
            } else {
                qualityBadge.classList.add('lossless');
                qualityBadge.textContent = "LOSSLESS";
            }
        } 
    }

    function applyDynamicTheme(base64Image) {
        const img = new Image();
        img.src = base64Image;
        img.onload = function() {
            const canvas = document.getElementById('colorCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1; canvas.height = 1;
            ctx.drawImage(img, 0, 0, 1, 1);
            const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;

            const root = document.documentElement.style;
            const accent = `rgb(${r},${g},${b})`;
            root.setProperty('--accent', accent);
            root.setProperty('--blob-1', `rgba(${r},${g},${b}, 0.8)`);
            root.setProperty('--blob-2', `rgba(${r+40},${g-20},${b+40}, 0.8)`);
            root.setProperty('--blob-3', `rgba(${r-20},${g+30},${b-10}, 0.6)`);
            
            const playBtn = document.getElementById('btnPlay');
            playBtn.style.background = accent;
            playBtn.style.color = (r*0.299 + g*0.587 + b*0.114) > 150 ? 'black' : 'white';
            playBtn.style.boxShadow = `0 0 30px ${accent}`;
            
            if(isShuffle) btnShuffle.style.color = accent;
            if(isRepeat) document.getElementById('btnRepeat').style.color = accent;
        }
    }

    function resetTheme() {
        const root = document.documentElement.style;
        root.setProperty('--accent', '#d4af37');
        root.setProperty('--blob-1', '#4facfe');
        root.setProperty('--blob-2', '#f093fb');
        root.setProperty('--blob-3', '#43e97b');
        const playBtn = document.getElementById('btnPlay');
        playBtn.style.background = 'rgba(255,255,255,0.15)';
        playBtn.style.color = 'white';
        playBtn.style.boxShadow = 'none';
        btnShuffle.style.color = "rgba(255,255,255,0.6)"; 
    }

    async function extractCoverArt(url) {
        scanBadge.style.opacity = "1";
        try {
            const response = await fetch(url, { headers: { 'Range': 'bytes=0-500000' } });
            if(!response.ok) throw new Error("Fail");
            const blob = await response.blob();

            jsmediatags.read(blob, {
                onSuccess: function(tag) {
                    const tags = tag.tags;
                    if (tags.picture) {
                        const { data, format } = tags.picture;
                        let base64String = "";
                        for (let i = 0; i < data.length; i++) { base64String += String.fromCharCode(data[i]); }
                        const base64 = `data:${format};base64,${window.btoa(base64String)}`;
                        
                        document.getElementById('albumCover').src = base64;
                        applyDynamicTheme(base64);
                        scanBadge.style.opacity = "0";
                    } else { scanBadge.style.opacity = "0"; }
                },
                onError: function(error) { scanBadge.style.opacity = "0"; }
            });
        } catch (e) { scanBadge.style.opacity = "0"; }
    }

    function checkTitleLength() {
        const wrapper = document.getElementById('titleWrapper');
        const title = document.getElementById('trackTitle');
        wrapper.style.animation = 'none'; wrapper.style.paddingLeft = '0';
        if(title.textContent.length > 18) {
            setTimeout(() => {
                wrapper.style.animation = 'scrollText 15s linear infinite';
                wrapper.style.paddingLeft = '100%';
            }, 100);
        }
    }

    function togglePlay() { if (audio.paused) { audio.play(); isPlaying = true; } else { audio.pause(); isPlaying = false; } updatePlayIcon(); }
    
    function updatePlayIcon() {
        const playBtn = document.getElementById('iconPlay');
        const pauseBtn = document.getElementById('iconPause');
        const card = document.getElementById('playerView');
        const art = document.getElementById('albumCover');
        if(!audio.paused) { 
            playBtn.style.display = 'none'; pauseBtn.style.display = 'block'; 
            card.classList.add('playing'); art.style.transform = "scale(1.05)";
        } else { 
            playBtn.style.display = 'block'; pauseBtn.style.display = 'none'; 
            card.classList.remove('playing'); art.style.transform = "scale(1)"; 
        }
    }

    function toggleShuffle() {
        isShuffle = !isShuffle;
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        btnShuffle.style.color = isShuffle ? accent : "rgba(255,255,255,0.6)";
    }

    function nextTrack() { 
        if (isShuffle) {
            let rand = Math.floor(Math.random() * playlist.length);
            while(rand === currentIndex && playlist.length > 1) { rand = Math.floor(Math.random() * playlist.length); }
            currentIndex = rand;
        } else {
            currentIndex = (currentIndex < playlist.length - 1) ? currentIndex + 1 : 0; 
        }
        loadTrack(currentIndex); 
    }

    function prevTrack() { currentIndex = (currentIndex > 0) ? currentIndex - 1 : playlist.length - 1; loadTrack(currentIndex); }
    
    function toggleRepeat() { 
        isRepeat = !isRepeat; audio.loop = isRepeat; 
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        document.getElementById('btnRepeat').style.color = isRepeat ? accent : "rgba(255,255,255,0.6)"; 
    }

    audio.addEventListener('ended', () => { if(!isRepeat) nextTrack(); });
    audio.addEventListener('pause', () => { isPlaying = false; updatePlayIcon(); });

    const progressBar = document.getElementById('progressBar');
    audio.addEventListener('timeupdate', () => {
        if(audio.duration) {
            progressBar.value = (audio.currentTime / audio.duration) * 100;
            document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            document.getElementById('duration').textContent = formatTime(audio.duration);
        }
    });
    progressBar.addEventListener('input', (e) => { audio.currentTime = (e.target.value / 100) * audio.duration; });

    function formatTime(seconds) {
        if(isNaN(seconds)) return "0:00";
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function resetPlayer() {
        audio.pause();
        audio.src = "";
        setupView.classList.remove('hidden-view');
        playerView.classList.add('hidden-view');
        playlist = [];
        currentIndex = 0;
        document.getElementById('folderLinkInput').value = "";
        document.getElementById('folderLinkInput').focus();
        document.querySelector('.btn-connect').textContent = "CONNECT";
        resetTheme();
    }
</script>
</body>
</html>